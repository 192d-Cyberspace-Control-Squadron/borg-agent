syntax = "proto3";

package agent.v1;

message DeviceIdentity {
  string device_id = 1; // stable GUID generated by agent
  string hostname  = 2;
  string os_build  = 3;
  string arch      = 4;
  string agent_version = 5;
}

message CheckInRequest {
  DeviceIdentity identity = 1;
  int64 now_unix_ms = 2;
}

message CheckInResponse {
  int64 server_unix_ms = 1;
  int32 recommended_poll_seconds = 2;
}

message InstalledProduct {
  string name = 1;
  string version = 2;
  string publisher = 3;
  string source = 4; // "uninstall_registry"
}

message InventoryReportRequest {
  DeviceIdentity identity = 1;
  repeated InstalledProduct products = 2;
}

message InventoryReportResponse {
  bool accepted = 1;
}

enum InstallerType {
  INSTALLER_TYPE_UNSPECIFIED = 0;
  INSTALLER_TYPE_MSI = 1;
  INSTALLER_TYPE_EXE = 2;
}

message Payload {
  string payload_id = 1;
  string sha256_hex = 2;
  uint64 size_bytes = 3;
  InstallerType installer_type = 4;
  repeated string installer_args = 5;
}

message Rule {
  string rule_type = 1; // e.g., "registry_uninstall_version_lt"
  string rule_json = 2; // JSON payload interpreted by agent
}

message Assignment {
  string assignment_id = 1;
  string update_id = 2;
  string title = 3;
  repeated Rule applicability = 4;
  Payload payload = 5;
  int64 deadline_unix_ms = 6; // optional; 0 if none
}

message GetPolicyRequest {
  DeviceIdentity identity = 1;
}

message GetPolicyResponse {
  repeated Assignment assignments = 1;
}

enum InstallState {
  INSTALL_STATE_UNSPECIFIED = 0;
  INSTALL_STATE_NOT_APPLICABLE = 1;
  INSTALL_STATE_NEEDED = 2;
  INSTALL_STATE_DOWNLOADING = 3;
  INSTALL_STATE_INSTALLING = 4;
  INSTALL_STATE_INSTALLED = 5;
  INSTALL_STATE_REBOOT_REQUIRED = 6;
  INSTALL_STATE_FAILED = 7;
}

message StatusEvent {
  string event_id = 1; // UUID
  string assignment_id = 2;
  string update_id = 3;
  InstallState state = 4;
  int32 exit_code = 5;
  string message = 6;
  int64 when_unix_ms = 7;
}

message ReportStatusRequest {
  DeviceIdentity identity = 1;
  repeated StatusEvent events = 2;
}

message ReportStatusResponse {
  bool accepted = 1;
}

service AgentService {
  rpc CheckIn(CheckInRequest) returns (CheckInResponse);
  rpc ReportInventory(InventoryReportRequest) returns (InventoryReportResponse);
  rpc GetPolicy(GetPolicyRequest) returns (GetPolicyResponse);
  rpc ReportStatus(ReportStatusRequest) returns (ReportStatusResponse);
}
